{"version":3,"file":"import-resolver.min.js","sources":["../src/settings.js","../src/exists.js","../src/core.js","../src/resolver.js","../src/main.js"],"sourcesContent":["import fs from 'fs';\nimport path from 'path';\nimport _ from 'lodash/fp';\n\nexport const defaultValidExtensions = ['.js', '.mjs', '.json', '.jsx'];\n\nlet settings = {};\nlet dependencies = {};\n\nconst moduleResolverSettings = _.flow(\n  _.get('plugins'),\n  _.filter(_.isArray),\n  _.find(p => _.first(p) === 'module-resolver'),\n  _.nth(1),\n  _.defaults({\n    root: [],\n    alias: [],\n  }),\n);\n\nconst resolverSettings = _.flow(\n  _.get('plugins'),\n  _.filter(_.isArray),\n  _.find(p => _.first(p) === 'resolver'),\n  _.nth(1),\n  _.defaults({\n    resolveDirs: [],\n  }),\n  r => ({ root: r.resolveDirs, alias: {} }),\n);\n\nexport const clear = () => {\n  settings = {};\n  dependencies = {};\n};\n\nexport const readWebpackConfig = (rootDir = '.') => {\n  let webpackConfig;\n  try {\n    // eslint-disable-next-line global-require, import/no-dynamic-require\n    webpackConfig = require(path.join(rootDir, 'webpack.config.js'));\n  } catch (err) {\n    return { root: [], alias: {} };\n  }\n\n  if (!_.isPlainObject(webpackConfig)) {\n    return { root: [], alias: {} };\n  }\n\n  return {\n    root: _.get('resolve.modules')(webpackConfig) || [],\n    alias: _.get('resolve.alias')(webpackConfig) || [],\n  };\n};\n\nexport const readSettings = (rootDir = '.') => {\n  if (_.isEmpty(settings)) {\n    let babelRC;\n    try {\n      babelRC = JSON.parse(fs.readFileSync(`${rootDir}/.babelrc`, {\n        encoding: 'utf8',\n      }).toString());\n    } catch (err) {\n      babelRC = {};\n    }\n\n    const mrs = moduleResolverSettings(babelRC);\n    const ms = resolverSettings(babelRC);\n    const wb = readWebpackConfig(rootDir);\n\n    settings = _.fromPairs([\n      ['root', _.flow(\n        _.flatMap(_.get('root')),\n        _.uniq,\n      )([ms, mrs, wb])],\n      ['alias', _.flow(\n        _.map(_.get('alias')),\n        _.flatMap(_.toPairs),\n        _.uniq,\n        _.fromPairs,\n      )([ms, mrs, wb])],\n    ]);\n  }\n\n  return _.defaults({\n    root: [],\n    alias: [],\n  })(settings);\n};\n\nexport const readDependencies = (rootDir = '.') => {\n  if (_.isEmpty(dependencies)) {\n    let p;\n    try {\n      p = JSON.parse(fs.readFileSync(`${rootDir}/package.json`, {\n        encoding: 'utf8',\n      }).toString());\n    } catch (err) {\n      p = {};\n    }\n\n    dependencies = _.flow(\n      pkg => _.flatMap(_.identity)(_.map(d => _.keys(_.get(d)(pkg)))([\n        'dependencies',\n        'peerDependencies',\n        'devDependencies',\n      ])),\n      _.uniq,\n      _.compact,\n    )(p);\n  }\n\n  return dependencies;\n};\n","import _ from 'lodash/fp';\nimport fs from 'fs';\nimport path from 'path';\n\nimport { defaultValidExtensions } from 'settings';\n\nexport const fileExists = (p, validExtensions = defaultValidExtensions) => {\n  const paths = _.concat(\n    p,\n    _.map(e => `${p}${e}`)(validExtensions),\n  );\n\n  return _.find((f) => {\n    try {\n      return fs.lstatSync(f).isFile();\n    } catch (err) {\n      return false;\n    }\n  })(paths);\n};\n\nexport const dirExists = (p) => {\n  try {\n    return fs.lstatSync(p).isDirectory();\n  } catch (e) {\n    return false;\n  }\n};\n\nconst exists = (mod, validExtensions) => {\n  let f = fileExists(mod, validExtensions);\n  if (f) {\n    return f;\n  }\n\n  if (dirExists(mod)) {\n    f = fileExists(path.join(mod, 'index'), validExtensions);\n    if (f) {\n      return f;\n    }\n\n    if (fileExists(path.join(mod, 'package.json'))) {\n      const p = JSON.parse(fs.readFileSync(`${mod}/package.json`, {\n        encoding: 'utf8',\n      }).toString());\n\n      const main = _.get('jsnext:main')(p) || _.get('main')(p);\n      f = path.join(mod, main);\n      if (fileExists(f, validExtensions)) {\n        return f;\n      }\n    }\n  }\n\n  return false;\n};\n\nexport default exists;\n","\nimport _ from 'lodash/fp';\n\nexport const coreModules = [\n  'assert', 'async_hooks', 'buffer_ieee754',\n  'buffer', 'child_process', 'cluster', 'console',\n  'constants', 'crypto', '_debugger', 'dgram',\n  'dns', 'domain', 'events', 'freelist', 'fs',\n  '_http_agent', '_http_client', '_http_common', '_http_incoming',\n  '_http_outgoing', '_http_server', 'http', 'http2', 'https',\n  'inspector', '_linklist', 'module', 'net',\n  'node-inspect/lib/_inspect',\n  'node-inspect/lib/internal/inspect_client',\n  'node-inspect/lib/internal/inspect_repl',\n  'os', 'path', 'perf_hooks', 'process', 'punycode', 'querystring',\n  'readline', 'repl', 'smalloc',\n  '_stream_duplex', '_stream_transform', '_stream_wrap', '_stream_passthrough', '_stream_readable', '_stream_writable',\n  'stream', 'string_decoder',\n  'sys', 'timers',\n  '_tls_common', '_tls_legacy', '_tls_wrap',\n  'tls', 'tty', 'url', 'util',\n  'v8/tools/codemap', 'v8/tools/consarray', 'v8/tools/csvparser', 'v8/tools/logreader', 'v8/tools/profile_view', 'v8/tools/splaytree',\n  'v8', 'vm', 'zlib',\n];\n\nexport default function isCore(mod) {\n  return _.includes(mod)(coreModules);\n}\n","// because tleunen/babel-plugin-module-resolver is broken\n// and building an import resolver is not a rocket science\n\nimport path from 'path';\nimport _ from 'lodash/fp';\n\nimport exists from 'exists';\nimport isCore from 'core';\n\nimport { readSettings, readDependencies, defaultValidExtensions } from 'settings';\n\nconst resolve = (source, file, options = {}) => {\n  if (isCore(source)) {\n    return { found: true, path: source };\n  }\n\n  const root = _.flow(\n    _.defaults({\n      root: process.cwd(),\n    }),\n    _.get('root'),\n  )(options);\n\n  if (_.isEmpty(source) || !source) {\n    return { found: false };\n  }\n\n  const settings = readSettings(root);\n\n  let aliasedSource = `${source}`;\n\n  aliasedSource = _.reduce((r, v) => {\n    const [alias, mod] = v;\n\n    return _.flow(\n      _.replace(new RegExp(`^${alias}`), mod),\n      _.replace(new RegExp(`${alias}$`), mod),\n    )(r);\n  })(aliasedSource)(_.entries(settings.alias));\n\n  const validExtensions = _.flow(\n    _.defaults({\n      extensions: defaultValidExtensions,\n    }),\n    _.get('extensions'),\n  )(options);\n\n  const rel = _.replace(/$.\\//, '')(aliasedSource);\n  const curDirMod = path.join(path.dirname(file), rel);\n  let f = exists(curDirMod, validExtensions);\n  if (f) {\n    return { found: true, path: f };\n  }\n\n  const rootPaths = _.map(r => path.join(root, r, aliasedSource))(settings.root);\n  f = _.flow(\n    _.map(p => exists(p, validExtensions)),\n    _.compact,\n    _.nth(0),\n  )(rootPaths);\n  if (f) {\n    return { found: true, path: f };\n  }\n\n  const deps = readDependencies(root);\n\n  if (_.find(d => _.startsWith(d)(source))(deps)) {\n    f = exists(path.join(root, 'node_modules', source), validExtensions);\n    if (f) {\n      return { found: true, path: f };\n    }\n  }\n\n  return { found: false };\n};\n\nexport default resolve;\n","import resolve from 'resolver';\n\nexport default {\n  interfaceVersion: 2,\n  resolve,\n};\n"],"names":["dependencies","moduleResolverSettings","_","flow","get","filter","isArray","find","first","p","nth","defaults","root","alias","resolverSettings","resolveDirs","r","rootDir","webpackConfig","require","path","join","err","isPlainObject","isEmpty","settings","babelRC","JSON","parse","fs","readFileSync","encoding","toString","ms","wb","readWebpackConfig","fromPairs","flatMap","uniq","mrs","map","toPairs","identity","keys","d","pkg","compact","defaultValidExtensions","paths","concat","e","validExtensions","f","lstatSync","isFile","isDirectory","mod","fileExists","dirExists","main","includes","coreModules","source","file","isCore","found","process","cwd","options","readSettings","aliasedSource","reduce","v","replace","entries","extensions","rel","curDirMod","dirname","exists","rootPaths","readDependencies","startsWith","deps","interfaceVersion","resolve"],"mappings":"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"}